@using Jeopicodus.ViewModels
@using Jeopicodus.Models
@using System.Security.Claims
@model GameDetailsViewModel

<div class="jumbotron">
    <img src="~/img/logo.png">
</div>

<div class="container">
    <div id="scoreboard" class="row">
        @{
            List<Team> TeamList = new List<Team>{};
        }
        @foreach(Team team in Model.Game.Teams)
        {
            TeamList.Add(team);
        }
        <div class="col-sm" id="team1-scoreboard">
            <h5>@TeamList[0].TeamName<span class="scoreboard-score">@Model.Game.ScoreTeam1</span></h5>
        </div>
        <div class="col-sm" id="team2-scoreboard">
            <h5><span class="scoreboard-score">@Model.Game.ScoreTeam2</span>@TeamList[1].TeamName</h5>
        </div>
    </div>
    <div id="gameboard">
        <div id="catagories" class="row">
            <div class="col-sm cat-1">
                @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = Model.Categories[0], QuestionId = 0 })
            </div>
            <div class="col-sm cat-2">
                @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = Model.Categories[1], QuestionId = 0 })
            </div>
            <div class="col-sm cat-3">
                @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = Model.Categories[2], QuestionId = 0 })
            </div>
            <div class="col-sm cat-4">
                @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = Model.Categories[3], QuestionId = 0 })
            </div>
            <div class="col-sm cat-5">
                @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = Model.Categories[4], QuestionId = 0 })
            </div>
        </div>
        <hr class="game-bar">
        @for(int i = 1; i <=5; i++)
        {
            var difficulty = "Easy";
            var index = 0;
            if(i % 2 == 0)
            {
                index = 1;
            }
            if(i > 2 && i < 5)
            {
                difficulty = "Medium";
            }
            else if (i == 5){
                difficulty = "Hard";
            }
            Question q1 = @Model.Questions[@Model.Categories[0] + "_" + @difficulty][index];
            Question q2 = @Model.Questions[@Model.Categories[1] + "_" + @difficulty][index];
            Question q3 = @Model.Questions[@Model.Categories[2] + "_" + @difficulty][index];
            Question q4 = @Model.Questions[@Model.Categories[3] + "_" + @difficulty][index];
            Question q5 = @Model.Questions[@Model.Categories[4] + "_" + @difficulty][index];

            <div id="level-@i" class="row">
                <div class="col-sm cat-q-1">
                    @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = (i*100).ToString(), QuestionId = @q1.Id })
                </div>
                <div class="col-sm cat-q-2">
                    @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = (i*100).ToString(), QuestionId = @q2.Id })
                </div>
                <div class="col-sm cat-q-3">
                    @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = (i*100).ToString(), QuestionId = @q3.Id })
                </div>
                <div class="col-sm cat-q-4">
                    @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = (i*100).ToString(), QuestionId = @q4.Id })
                </div>
                <div class="col-sm cat-q-5">
                    @await Html.PartialAsync("_QuestionCard", new QuestionCardViewModel(){Value = (i*100).ToString(), QuestionId = @q5.Id })
                </div>
            </div>
        }
        <div class="modalCards">
            <div id="questionModal" class="modal" data-easein="whirlIn"  tabindex="-1" role="dialog" aria-labelledby="questionModal" aria-hidden="true">
                <div class="modal-dialog h-100 d-flex flex-column justify-content-center my-0" >
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title">
                                Question
                            </h4>
                        </div>
                        <div class="modal-body">
                        </div>
                        <div class="modal-footer">
                            <button id="modal-btn" class="btn btn-default" aria-hidden="true" data-dismiss="modal">
                                Answer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.2/velocity.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.2.2/velocity.ui.min.js"></script>

<script type="text/javascript">
    const hubConnection = new signalR.HubConnectionBuilder()
                .withUrl("/gameHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();
    var playerTeam = '@Model.UserTeam';
    hubConnection.start();

    $(document).ready(function(){
        $(".col-sm").click(function(event){
            if(($(this).attr('class').indexOf('cat-q') !== -1) && ($(this).find(".card").attr('class').indexOf('answered') === -1)) {
                var questionId = event.target.closest(".card").id;
                hubConnection.invoke('QuestionClicked', questionId +"#" + playerTeam);

            }
        });
        $(".modal").each(function(l){
            $(this).on("show.bs.modal", function(l){
                var o=$(this).attr("data-easein");
                $(".modal-dialog").velocity("transition."+o)
            })
        });

        hubConnection.on('showQuestion', id => {
            console.log(id);
            $(document).find("#"+id+".card").addClass("answered");
            var question = getQuestion(id);
            $(".modal-body").text(question);
            $(".modal").modal('show');
        });

        function getQuestion(id){
            var questionList = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Game.Questions) as string);
            
            for(let i = 0; i < questionList.length; i++){
                if(questionList[i].Id == id){
                    return questionList[i].Prompt;
                }
            }
            return "Question Not Found";
        }

    });
    
</script>